#+TITLE: Persistence Delegate for the System
#+AUTHOR: VLEAD
#+DATE: [2016-07-07 Thu]
#+SETUPFILE: ../../org-templates/level-2.org
#+TAGS: boilerplate(b)
#+EXCLUDE_TAGS: boilerplate
#+OPTIONS: ^:nil

* Persistence Delegate
  Persistence Delegate encapsulates a set of functions where each function performs a
  specific task.  With the use of these delegates, the core implementation of
  the =system= will not alter but by plugging delegates that are specific to
  each environment, for example, be it either objects or persistence, the
  =system= for that particular environment is derived while not modifying the
  =system= class.
  
** Initialize Persistence Delegate
   Provides all the delegates that operate on objects.

*** class_persistence_delegate 
#+NAME: class_persistence_delegate
#+BEGIN_SRC python
class PersistenceDelegate():
   
    def __init__(self):
        pass
        
#+END_SRC


*** get_role_set
#+NAME: persistent_get_role_set
#+begin_src python
    def get_role_set(self):
        return Role.get_all()

#+end_src


*** get_user_set
#+NAME: persistent_get_user_set
#+begin_src python
    def get_user_set(self):
        return User.get_all()

#+end_src


*** Tests
#+NAME: test_class_persistent_delegate
#+BEGIN_SRC python
class TestPersistentDelegate(TestCase):
    TESTING = True

    def create_app(self):
        app = create_app(config)
        return app

    def setUp(self):
        db.create_all()
        self.persistent_delegate = PersistenceDelegate()
        
    def tearDown(self):
        db.session.remove()
        db.drop_all()
        self.persistent_delegate = None

#+END_SRC


** Other functions

   Other functions that help =System= perform the operations. 
   
***  Check if =user= already exists
    This function checks if a user is already in the user-set of the =System=.
#+NAME: persistent_user_exists
#+BEGIN_SRC python
    def user_exists(self, user):
        if self.email_exists(user.get("email")):
            return user == self.get_user(email=user.get("email"))
        else:
            return False

#+END_SRC

**** Tests
#+NAME: test_persistent_user_exists
#+BEGIN_SRC python
    def test_user_exists(self):
        print "test_user_exists"
        name = Name(name="some user")
        email = Email(email="tt@kk.com")
        role = Role(name="guest", centre_nc=None, centre_oc=None)
        role.save()
        guest_role = Role.get_by_id(1)
        user = User(name=name, email=email,
                        roles=[guest_role])

        user = self.persistent_delegate.add_user(user)
        self.assertEqual(self.persistent_delegate.user_exists(user), True)
        
#+END_SRC


***  Check if =name= already exists
    This function checks if a name is already in the database of the =System=.
#+NAME: persistent_name_exists
#+BEGIN_SRC python
    def name_exists(self, name):
        return name == self.get_name(name=name.get("name"))

#+END_SRC

**** Tests
#+NAME: test_persistent_name_exists
#+BEGIN_SRC python
    def test_name_exists(self):
        print "test_name_exists"
        name = Name(name="some user")
        name.save()
        self.assertEqual(self.persistent_delegate.name_exists(name), True)
        name = Name(name="Temp user")
        self.assertEqual(self.persistent_delegate.name_exists(name), False)

#+END_SRC


***  Check if =email= already exists
    This function checks if email is already in the database of the =System=.
#+NAME: persistent_email_exists
#+BEGIN_SRC python
    def email_exists(self, email):
        return email == self.get_email(email=email.get("email"))

#+END_SRC

**** Tests
#+NAME: test_persistent_email_exists
#+BEGIN_SRC python
    def test_email_exists(self):
         print "test_email_exists"
         email = Email(email="someuser@gnu.org")
         email.save()
         self.assertEqual(self.persistent_delegate.email_exists(email), True)
         email = Email(email="abc@gnu.org")
         self.assertEqual(self.persistent_delegate.email_exists(email), False)

#+END_SRC


***  Add a user to the system
    This function adds a user to the user-set maintained by the system.
#+NAME: persistent_add_user
#+BEGIN_SRC python
    def add_user(self, user):
        name = user.get("name")
        email = user.get("email")
        try:
            if not self.name_exists(name):
                name.save()
            email.save()
            user.save()
            return self.get_user(email=email)
        except Exception as e:
            return None

#+END_SRC

**** Tests
#+NAME: test_persistent_add_user
#+BEGIN_SRC python
    def test_add_user(self):
        print "test_add_user"
        name = Name(name="some user")
        email = Email(email="tt@kk.com")
        role = Role(name="guest", centre_nc=None, centre_oc=None)
        role.save()
        guest_role = Role.get_by_id(1)
        user = User(name=name, email=email,
                        roles=[guest_role])
                        
        name_1 = Name(name="dummy user")
        email_1 = Email(email="dummy@kk.com")
        role_1 = Role(name="guest", centre_nc=None, centre_oc=None)
        role_1.save()
        guest_role_1 = Role.get_by_id(1)
        user_1 = User(name=name_1, email=email_1,
                        roles=[guest_role_1])
        
        user = self.persistent_delegate.add_user(user)
        self.assertEqual(self.persistent_delegate.user_exists(user), True)
        self.assertEqual(self.persistent_delegate.user_exists(user_1), False)
    
#+END_SRC


***  Update a user in the system
#+NAME: persistent_update_user
#+BEGIN_SRC python 
    def update_user(self, name, email, user):
        user.set(name=name)
        user.set(email=email)
        user.save()
        return user

#+END_SRC
**** Tests
#+NAME: test_persistent_update_user
#+BEGIN_SRC python
    def test_update_user(self):
        print "test_update_user"
        name = Name(name="some user")
        name.save()
        email = Email(email="tt@kk.com")
        email.save()
        user = User(name=name,
                    email=email,
                    roles=[Role.get_by_id(2)], user_status="active")
        new_user = self.persistent_delegate.add_user(user)

        user_name1=Name(name="alaska")
        user_name1.save()
        user_email1=Email(email="alaska@gmail.com")
        user_email1.save()
        updated_user = self.persistent_delegate.update_user(user_name1, user_email1, new_user)
        self.assertEqual(updated_user.get("name").get("name"), "alaska")
 
#+END_SRC


***  Delete a user from the system
#+NAME: persistent_delete_user
#+BEGIN_SRC python 
    def delete_user(self, user):
        user.set(user_status="inactive")
        user.save()
        return user
#+END_SRC
**** Tests
#+NAME: test_persistent_delete_user
#+BEGIN_SRC python
    def test_delete_user(self):
        name = Name(name="some user")
        name.save()
        email = Email(email="tt@kk.com")
        email.save()
        user = User(name=name,
                    email=email,
                    roles=[Role.get_by_id(2)], user_status="active")
        new_user = self.persistent_delegate.add_user(user)
        del_user = self.persistent_delegate.delete_user(new_user)
        self.assertEqual(del_user.get("user_status") , "inactive")
#+END_SRC


***  Add a role to the user in the system
#+NAME: persistent_add_role_to_user
#+BEGIN_SRC python 
    def add_role_to_user(self, user, role):
        roles = user.get("roles")
        roles.append(role)
        return user

#+END_SRC
**** Tests
#+NAME: test_persistent_add_role_to_user
#+BEGIN_SRC python
    def test_add_role_to_user(self):
        print "test_add_role_to_user"
        name = Name(name="some user")
        email = Email(email="tt@kk.com")
        name.save()
        email.save()

        guest_role = Role(name="guest", centre_oc=None, centre_nc=None)
        guest_role.save()

        reviewer_role = Role(name="reviewer", centre_oc=None, centre_nc=None)
        reviewer_role.save()

        user = User(name=name, email=email, roles=[guest_role])
        user.save()
        
        user_with_new_role = self.persistent_delegate.add_role_to_user\
                             (user, reviewer_role)
        self.assertTrue(len(user_with_new_role.get('roles')) == 2)

#+END_SRC


***  Get all Active users from the system

    This return the user_set maintained by the system.
#+NAME: persistent_get_users
#+BEGIN_SRC python
    def get_users(self):
        return self.get_active_users()

#+END_SRC
**** Tests
#+NAME: test_persistent_get_users
#+BEGIN_SRC python
    def test_get_users(self):
        print "test_get_users"
        name = Name(name="some user")
        name.save()
        email = Email(email="tt@kk.com")
        email.save()
        user = User(name=name,
                    email=email,
                    roles=[Role.get_by_id(2)], user_status="active")
        new_user = self.persistent_delegate.add_user(user)
        self.assertEqual(len(self.persistent_delegate.get_users()), 2)

#+END_SRC


***  Check if =role= already exists
    This function checks if a user is already in the role-set of the =System=.
#+NAME: persistent_role_exists
#+BEGIN_SRC python
    def role_exists(self, role):
        if role in Role.get_all():
            return True
        else:
            return False

#+END_SRC

**** Tests
#+NAME: test_persistent_role_exists
#+BEGIN_SRC python
    def test_role_exists(self):
         print "test_role_exists"
         role = Role.get_by_id(1)
         self.assertEqual(self.persistent_delegate.role_exists(role), True)

#+END_SRC


***  Add a role to the system
    This function adds a role to the role-set maintained by the system.
#+NAME: persistent_add_role
#+BEGIN_SRC python
    def add_role(self, name, new_oc, centre_nc):
        new_role = Role(name=name, centre_oc=new_oc, centre_nc=centre_nc)
        new_role.save()
        return new_role
#+END_SRC

**** Tests
#+NAME: test_persistent_add_role
#+BEGIN_SRC python
    def test_add_role(self):
         print "test_add_role"
         role = self.persistent_delegate.add_role("guest", None, None)
         reviewer_role = Role(name='reviewer', centre_oc=None, centre_nc=None)
         self.assertEqual(self.persistent_delegate.role_exists(role), True)
         self.assertEqual(self.persistent_delegate.role_exists(reviewer_role),
                            False)

#+END_SRC


***  Get all roles from the System
    This return the role_set maintained by the system.
#+NAME: persistent_get_roles
#+BEGIN_SRC python
    def get_roles(self):
        self.role_set = Role.get_all()
        return self.role_set

#+END_SRC
**** Tests
#+NAME: test_persistent_get_roles
#+BEGIN_SRC python
    def test_get_roles(self):
         print "test_get_roles"
         self.assertEqual(len(self.persistent_delegate.get_roles()), 4)

#+END_SRC


***  Check if =institute= already exists
    This function checks if a user is already in the institute-set of the =System=.
#+NAME: persistent_institute_exists
#+BEGIN_SRC python
    def institute_exists(self, institute):
        institute_name = institute.get("name")
        if institute_name:
            return institute == self.get_institute(name=institute_name)
        else:
            return False

#+END_SRC

**** Tests
#+NAME: test_persistent_institute_exists
#+BEGIN_SRC python
    def test_institute_exists(self):
         print "test_institute_exists"
         institute = Institute(name="IIIT", address="Hyderabad")
         institute = self.persistent_delegate.add_institute(institute)
         self.assertEqual(self.persistent_delegate.institute_exists(institute),
                           True)

    def test_institute_does_not_exists(self):
         print "test_institute_does_not_exists"
         institute = Institute(name="IIIT", address="Hyderabad")
         self.assertEqual(self.persistent_delegate.institute_exists(institute),
                          False)

#+END_SRC


***  Add an institute to the system
    This function adds an institute to the institute-set maintained by the system.
#+NAME: persistent_add_institute
#+BEGIN_SRC python
    def add_institute(self, institute):
        institute.save()
        return institute

#+END_SRC

**** Tests
#+NAME: test_persistent_add_institute
#+BEGIN_SRC python
    def test_add_institute(self):
         print "test_add_institute"
         institute = Institute(name="IIIT", address='Hyderabad')
         institute = self.persistent_delegate.add_institute(institute)
         self.assertEqual(self.persistent_delegate.institute_exists(institute),
                          True)

#+END_SRC


***  Update an institute in the system
#+NAME: persistent_update_institute
#+BEGIN_SRC python
    def update_institute(self, institute, name, address):
        institute.set(name=name)
        institute.set(address=address)
        institute.save()
        return institute
#+END_SRC
**** Tests
#+NAME: test_persistent_update_institute
#+BEGIN_SRC python
    def test_update_institute(self):
         print "test_update_institute"
         ins = Institute(name='IIIT',address='Hyderabad')
         institute = self.persistent_delegate.add_institute(ins)
         updated_institute = self.persistent_delegate.update_institute(ins, "IIT", "Madras")
         self.assertEqual(self.persistent_delegate.institute_exists(institute), True)
         self.assertEqual(updated_institute.get("name"), "IIT")
         self.assertEqual(updated_institute.get("address"), "Madras")
#+END_SRC


***  Get all institutes from the system
    This return the institute_set maintained by the system.
#+NAME: persistent_get_institutes
#+BEGIN_SRC python
    def get_institutes(self):
        self.institute_set = Institute.query.all()   
        return self.institute_set

#+END_SRC

**** Tests
#+NAME: test_persistent_get_institutes
#+BEGIN_SRC python
    def test_get_institutes(self):
         print "test_get_institutes"
         ins = Institute(name='IIIT',address='Hyderabad')
         inst = self.persistent_delegate.add_institute(ins)
         self.assertEqual(len(self.persistent_delegate.get_institutes()), 1)

#+END_SRC


***  Check if =oc= already exists
    This function checks if an outreach-centre is already in the oc-set of the =System=.
#+NAME: persistent_oc_exists
#+BEGIN_SRC python
    def oc_exists(self, oc):
        institute = oc.get("institute")
        if institute:
            return oc == self.get_oc(institute=institute)
        else:
            return False
#+END_SRC

**** Tests
#+NAME: test_persistent_oc_exists
#+BEGIN_SRC python
    def test_oc_exists(self):
         print "test_oc_exists"
         institute = Institute(name="IIIT", address="Hyderabad")
         institute.save()
         oc = self.persistent_delegate.add_oc(institute)
         self.assertEqual(self.persistent_delegate.oc_exists(oc), True)

#+END_SRC


***  Add a oc to the system
    This function adds an outreach centre to the oc-set maintained by the system.
#+NAME: persistent_add_oc
#+BEGIN_SRC python
    def add_oc(self, institute):
        try:
            new_oc = OC(institute=institute, spokes=[], oc_targets=[])
            new_oc.save()
            new_role = self.add_role("OCC", new_oc, None)
            new_role.save()
            return new_oc
        except Exception as e:
            raise e

#+END_SRC

**** Tests
#+NAME: test_persistent_add_oc
#+BEGIN_SRC python
    def test_add_oc(self):
         print "test_persistent_add_oc"
         institute = Institute(name="IIIT", address="Hyderabad")
         institute.save()
         oc = self.persistent_delegate.add_oc(institute)
         self.assertEqual(self.persistent_delegate.oc_exists(oc), True)
#+END_SRC


***  Add a nc to the system
    This function adds an outreach centre to the nc-set maintained by the system.
#+NAME: persistent_add_nc
#+BEGIN_SRC python
    def add_nc(self, institute, oc):
        try:
            new_nc = NC(institute=institute, hub=oc,
                        nc_targets=[], workshops=[])
            new_nc.save()
            oc.append_spoke(new_nc)
            new_role = self.add_role("NCC", None, new_nc)
            new_role.save()
            return new_nc
        except Exception as e:
            raise e

#+END_SRC

**** Tests
#+NAME: test_persistent_add_nc
#+BEGIN_SRC python
    def test_add_nc(self):
         print "test_persistent_add_nc"
         institute = Institute(name="IIIT", address="Hyderabad")
         institute.save()
         oc = OC(institute=institute, spokes=[], oc_targets=[])
         oc.save()
         nc = self.persistent_delegate.add_nc(institute, oc)
         self.assertEqual(self.persistent_delegate.nc_exists(nc), True)

#+END_SRC


***  Get ocs from system

    This return the oc_set maintained by the system.
#+NAME: persistent_get_ocs
#+BEGIN_SRC python
    def get_ocs(self):
        self.oc_set = OC.query.all()
        return self.oc_set

#+END_SRC

#+NAME: test_persistent_get_ocs
#+BEGIN_SRC python
    def test_get_ocs(self):
         print "test_get_ocs"
         ins = Institute(name='IIIT',address='Hyderabad')
         ins.save()
         oc = self.persistent_delegate.add_oc(Institute.get_by_id(1),
                                                spokes, oc_target)
         self.assertEqual(len(self.persistent_delegate.get_ocs()), 1)

#+END_SRC


***  Check if =nc= already exists
    This function checks if a nodal-centre is already in the nc-set of the =System=.
#+NAME: persistent_nc_exists
#+BEGIN_SRC python
    def nc_exists(self, nc):
        institute = nc.get("institute")
        if institute:
            return nc == self.get_nc(institute=institute)
        else:
            return False
#+END_SRC

**** Tests
#+NAME: test_persistent_nc_exists
#+BEGIN_SRC python
    def test_nc_exists(self):
         print "test_persistent_nc_exists"
         institute = Institute(name="IIIT", address="Hyderabad")
         institute.save()
         oc = OC(institute=institute, spokes=[], oc_targets=[])
         oc.save()
         nc = self.persistent_delegate.add_nc(institute, oc)
         self.assertEqual(self.persistent_delegate.nc_exists(nc), True)
#+END_SRC


***  Get ncs from system

    This return the nc_set maintained by the system.
#+NAME: persistent_get_ncs
#+BEGIN_SRC python
    def get_ncs(self):
        self.nc_set = NC.query.all()
        return self.nc_set

#+END_SRC

#+NAME: test_persistent_get_ncs
#+BEGIN_SRC python
    def test_get_ncs(self):
         print "test_get_ncs"
         ins = Institute(name='IIIT',address='Hyderabad')
         ins.save()
         institute=Institute.get_by_id(1)
         spokes=[]
         oc_target = None
         oc = self.persistent_delegate.add_oc(Institute.get_by_id(1),
                                                spokes, oc_target)
         nc_target=None
         workshops=[]
         nc = self.persistent_delegate.add_nc(institute, oc, nc_target,
                                                workshops)
         self.assertEqual(len(self.persistent_delegate.get_ncs()), 1)

#+END_SRC


***  Get all active_users from system
    This function returns All the active users from the user_set.
#+NAME: persistent_get_active_users
#+BEGIN_SRC python
    def get_active_users(self): 
        user_set = User.get_all()
        active_user_set = filter(lambda x: x.get("user_status")=="active",
                                  user_set)
        return active_user_set
#+END_SRC
**** Tests
#+NAME: test_persistent_get_active_users
#+BEGIN_SRC python
    def test_get_active_users(self):
         name = Name(name="some user")
         name.save()
         email = Email(email="tt@kk.com")
         email.save()
         user = User(name=name,
                     email=email,
                     roles=[Role.get_by_id(1)], user_status="active")
         user = self.persistent_delegate.add_user(user)
         self.assertEqual(self.persistent_delegate.user_exists(user), True)
         active_user_list = self.persistent_delegate.get_active_users()
         self.assertEqual(len(active_user_list), 2)

#+END_SRC


***  Check if =workshop= already exists
    This function checks if a workshop is already in the workshop-set of the =System=.
#+NAME: persistent_workshop_exists
#+BEGIN_SRC python
    def workshop_exists(self, workshop):
        name = workshop.get("name")
        institute = workshop.get("institute")
        nc = workshop.get("nc")
        date = workshop.get("date")
        if name and institute and nc and date:
            return workshop == self.get_workshop(name=name, 
                                                 institute=institute,
                                                 nc=nc,
                                                 date=date)
        else:
            return False


#+END_SRC

**** Tests
#+NAME: test_persistent_workshop_exists
#+BEGIN_SRC python
    def test_workshop_exists(self):
        print "test_workshop_exists"

        status = Status(name="pending")
        status.save()
        inst1 = Institute(name="NIT", address="Suratkal")
        inst1.save()
        inst2 = Institute(name="IIIT", address="Hyderabad")
        inst2.save()
        inst3 = Institute(name="HCU", address="Hyderabad")
        inst3.save()
        
        oc = OC(institute=inst1, spokes=[], oc_targets=[])
        oc.save()
        
        nc = NC(institute=inst2, hub=oc,
                    nc_targets=[], workshops=[])
        nc.save()
        
        date = datetime.datetime.strptime("2016-12-23", "%Y-%m-%d").date()
        
        oc_target = OCTarget(usage=400, date=date, oc=oc, nc_targets=[])
        oc_target.save()
        nc_target = NCTarget(usage=400, date=date, nc=nc, 
                                 oc_target=oc_target, ws_targets=[])
        nc_target.save()
        ws_target = WSTarget(usage=4000, participants=200, experiments=20,
                                 date=date, nc_target=nc_target)
        ws_target.save()
        
        workshop = self.persistent_delegate.add_workshop(name="Test workshop",
                                                             institute=inst3,
                                                             status=status, 
                                                             nc=nc,
                                                             ws_target=\
                                                             ws_target,
                                                             date=date)
        self.assertEqual(self.persistent_delegate.workshop_exists(workshop), 
                             True)

#+END_SRC


***  Add a workshop to the system
    This function adds a workshop to the workshop-set maintained by the system.
#+NAME: persistent_add_workshop
#+BEGIN_SRC python
    def add_workshop(self, name, institute, ws_target, status, \
                         nc, date):
        new_workshop = Workshop(name=name,
                                institute=institute,
                                status=status, 
                                artefacts=[], 
                                nc=nc,
                                ws_target=ws_target,
                                date=date,
                                participants=0,
                                experiments=0,
                                usage=0)
        new_workshop.save()
        return new_workshop

#+END_SRC

**** Tests
#+NAME: test_persistent_add_workshop
#+BEGIN_SRC python
    def test_add_workshop(self):
        print "test_add_workshop"
        status = Status(name="pending")
        status.save()
        inst1 = Institute(name="NIT", address="Suratkal")
        inst1.save()
        inst2 = Institute(name="IIIT", address="Hyderabad")
        inst2.save()
        inst3 = Institute(name="HCU", address="Hyderabad")
        inst3.save()
        
        oc = OC(institute=inst1, spokes=[], oc_targets=[])
        oc.save()
        
        nc = NC(institute=inst2, hub=oc,
                    nc_targets=[], workshops=[])
        nc.save()
        
        date = datetime.datetime.strptime("2016-12-23", "%Y-%m-%d").date()
        
        oc_target = OCTarget(usage=400, date=date, oc=oc, nc_targets=[])
        oc_target.save()
        nc_target = NCTarget(usage=400, date=date, nc=nc, 
                                 oc_target=oc_target, ws_targets=[])
        nc_target.save()
        ws_target = WSTarget(usage=4000, participants=200, experiments=20,
                                 date=date, nc_target=nc_target)
        ws_target.save()
        
        workshop = self.persistent_delegate.add_workshop(name="Test workshop",
                                                             institute=inst3,
                                                             status=status, 
                                                             nc=nc,
                                                             ws_target=\
                                                             ws_target,
                                                             date=date)

        self.assertEqual(self.persistent_delegate.workshop_exists(workshop),
                         True)
#+END_SRC

***  Cancel workshop
#+NAME: persistent_cancel_workshop
#+BEGIN_SRC python
    def cancel_workshop(self, workshop):
        cancelled = self.get_status(name="cancelled")
        if cancelled:
            workshop.set(status=cancelled)
            workshop.save()
        return workshop
#+END_SRC

**** Tests 
#+NAME: test_persistent_cancel_workshop
#+BEGIN_SRC python
    def test_cancel_workshop(self):
        print "test_cancel_workshop"
        pending_status = Status(name="pending")
        pending_status.save()
        cancel_status = Status(name="cancelled")
        cancel_status.save()
        inst1 = Institute(name="NIT", address="Suratkal")
        inst1.save()
        inst2 = Institute(name="IIIT", address="Hyderabad")
        inst2.save()
        inst3 = Institute(name="HCU", address="Hyderabad")
        inst3.save()
        oc = OC(institute=inst1, spokes=[], oc_targets=[])
        oc.save()
        nc = NC(institute=inst2, hub=oc,
                    nc_targets=[], workshops=[])
        nc.save()
        date = datetime.datetime.strptime("2016-12-23", "%Y-%m-%d").date()
        oc_target = OCTarget(usage=400, date=date, oc=oc, nc_targets=[])
        oc_target.save()
        nc_target = NCTarget(usage=400, date=date, nc=nc, 
                                 oc_target=oc_target, ws_targets=[])
        nc_target.save()
        ws_target = WSTarget(usage=4000, participants=200, experiments=20,
                                 date=date, nc_target=nc_target)
        ws_target.save()

        workshop = Workshop(name="Test workshop",
                            institute=inst3,
                            status=pending_status, 
                            artefacts=[], 
                            nc=nc,
                            ws_target=ws_target,
                            date=date,
                            participants=0,
                            experiments=0,
                            usage=0)
        workshop.save()

        cancelled_workshop = self.persistent_delegate.cancel_workshop(workshop)

        self.assertEqual(cancelled_workshop.get("status").get("name"), 
                             cancel_status.get("name"))

#+END_SRC
***  Conduct Workshop
#+NAME: persistent_conduct_workshop
#+BEGIN_SRC python
    def conduct_workshop(self, workshop):
        completed = self.get_status(name="completed")
        workshop.set(status=completed)
        workshop.save()
        return workshop
#+END_SRC
**** Tests
#+NAME: test_persistent_conduct_workshop
#+BEGIN_SRC python
    def test_conduct_workshop(self):
        print "test_conduct_workshop"
        pending_status = Status(name="pending")
        pending_status.save()
        completed_status = Status(name="completed")
        completed_status.save()
        inst1 = Institute(name="NIT", address="Suratkal")
        inst1.save()
        inst2 = Institute(name="IIIT", address="Hyderabad")
        inst2.save()
        inst3 = Institute(name="HCU", address="Hyderabad")
        inst3.save()
        oc = OC(institute=inst1, spokes=[], oc_targets=[])
        oc.save()
        nc = NC(institute=inst2, hub=oc,
                    nc_targets=[], workshops=[])
        nc.save()
        date = datetime.datetime.strptime("2016-12-23", "%Y-%m-%d").date()
        oc_target = OCTarget(usage=400, date=date, oc=oc, nc_targets=[])
        oc_target.save()
        nc_target = NCTarget(usage=400, date=date, nc=nc, 
                                 oc_target=oc_target, ws_targets=[])
        nc_target.save()
        ws_target = WSTarget(usage=4000, participants=200, experiments=20,
                                 date=date, nc_target=nc_target)
        ws_target.save()

        workshop = Workshop(name="Test workshop",
                            institute=inst3,
                            status=pending_status, 
                            artefacts=[], 
                            nc=nc,
                            ws_target=ws_target,
                            date=date,
                            participants=0,
                            experiments=0,
                            usage=0)
        workshop.save()

        conducted_workshop = self.persistent_delegate.conduct_workshop(workshop)
        self.assertEqual(conducted_workshop.get("status").get("name"), 
                             completed_status.get("name"))

#+END_SRC

***  Approve Workshop
#+NAME: persistent_approve_workshop
#+BEGIN_SRC python
    def approve_workshop(self, workshop):
        approved = self.get_status(name="approved")
        workshop.set(status=approved)
        workshop.save()
        return workshop
#+END_SRC
**** Tests
#+NAME: test_persistent_approve_workshop
#+BEGIN_SRC python
    def test_approve_workshop(self):
        print "test_approve_workshop"
        pending_for_approval = Status(name="pending for approval")
        pending_for_approval.save()
        approved_status = Status(name="approved")
        approved_status.save()
        inst1 = Institute(name="NIT", address="Suratkal")
        inst1.save()
        inst2 = Institute(name="IIIT", address="Hyderabad")
        inst2.save()
        inst3 = Institute(name="HCU", address="Hyderabad")
        inst3.save()
        oc = OC(institute=inst1, spokes=[], oc_targets=[])
        oc.save()
        nc = NC(institute=inst2, hub=oc,
                    nc_targets=[], workshops=[])
        nc.save()
        date = datetime.datetime.strptime("2016-12-23", "%Y-%m-%d").date()
        oc_target = OCTarget(usage=400, date=date, oc=oc, nc_targets=[])
        oc_target.save()
        nc_target = NCTarget(usage=400, date=date, nc=nc, 
                                 oc_target=oc_target, ws_targets=[])
        nc_target.save()
        ws_target = WSTarget(usage=4000, participants=200, experiments=20,
                                 date=date, nc_target=nc_target)
        ws_target.save()

        workshop = Workshop(name="Test workshop",
                            institute=inst3,
                            status=pending_for_approval, 
                            artefacts=[], 
                            nc=nc,
                            ws_target=ws_target,
                            date=date,
                            participants=0,
                            experiments=0,
                            usage=0)
        workshop.save()

        approved_workshop = self.persistent_delegate.approve_workshop(workshop)

        self.assertEqual(approved_workshop.get("status").get("name"),
                             approved_status.get("name"))
#+END_SRC
***  Reschedule Workshop
#+NAME: persistent_reschedule_workshop
#+BEGIN_SRC python
    def reschedule_workshop(self, workshop, wstarget):
        pending = self.get_status(name="pending")
        workshop.set(status=pending)
        workshop.set(ws_target=wstarget)
        return workshop

#+END_SRC
**** Tests
#+NAME: test_persistent_reschedule_workshop
#+BEGIN_SRC python
    def test_reschedule_workshop(self):
        print "test_reschedule_workshop"
        pending_status = Status(name="pending")
        pending_status.save()
        completed_status = Status(name="completed")
        completed_status.save()
        inst1 = Institute(name="NIT", address="Suratkal")
        inst1.save()
        inst2 = Institute(name="IIIT", address="Hyderabad")
        inst2.save()
        inst3 = Institute(name="HCU", address="Hyderabad")
        inst3.save()
        oc = OC(institute=inst1, spokes=[], oc_targets=[])
        oc.save()
        nc = NC(institute=inst2, hub=oc,
                    nc_targets=[], workshops=[])
        nc.save()
        date = datetime.datetime.strptime("2016-12-23", "%Y-%m-%d").date()
        oc_target = OCTarget(usage=400, date=date, oc=oc, nc_targets=[])
        oc_target.save()
        nc_target = NCTarget(usage=400, date=date, nc=nc, 
                                 oc_target=oc_target, ws_targets=[])
        nc_target.save()
        ws_target = WSTarget(usage=4000, participants=200, experiments=20,
                                 date=date, nc_target=nc_target)
        ws_target.save()

        workshop = Workshop(name="Test workshop",
                            institute=inst3,
                            status=pending_status, 
                            artefacts=[], 
                            nc=nc,
                            ws_target=ws_target,
                            date=date,
                            participants=0,
                            experiments=0,
                            usage=0)
        workshop.save()
        new_target_date = datetime.datetime.strptime("05-07-2016",\
                                                    "%d-%m-%Y").date()
        new_wstarget = WSTarget(usage = 3000,
                                participants = 200,
                                experiments = 20,
                                date = new_target_date,
                                nc_target = nc_target)

        new_wstarget.save()

        rescheduled_workshop = self.persistent_delegate.reschedule_workshop\
          (workshop, new_wstarget)
        self.assertEqual(rescheduled_workshop.get("status").get("name"), pending_status.get("name"))
        self.assertEqual(rescheduled_workshop.get("ws_target").get("usage"),
                             3000)
#+END_SRC
***  Reject Workshop
#+NAME: persistent_reject_workshop
#+BEGIN_SRC python
    def reject_workshop(self, workshop):
        rejected = self.get_status(name="rejected")
        workshop.set(status = rejected)
        return workshop
#+END_SRC
**** Tests
#+NAME: test_persistent_reject_workshop
#+BEGIN_SRC python
    def test_reject_workshop(self):
        print "test_reject_workshop"

        reject_status = Status(name="rejected")
        reject_status.save()
        pending_for_approval_status = Status(name="pending for approval")
        pending_for_approval_status.save()
        inst1 = Institute(name="NIT", address="Suratkal")
        inst1.save()
        inst2 = Institute(name="IIIT", address="Hyderabad")
        inst2.save()
        inst3 = Institute(name="HCU", address="Hyderabad")
        inst3.save()
        oc = OC(institute=inst1, spokes=[], oc_targets=[])
        oc.save()
        nc = NC(institute=inst2, hub=oc,
                    nc_targets=[], workshops=[])
        nc.save()
        date = datetime.datetime.strptime("2016-12-23", "%Y-%m-%d").date()
        oc_target = OCTarget(usage=400, date=date, oc=oc, nc_targets=[])
        oc_target.save()
        nc_target = NCTarget(usage=400, date=date, nc=nc, 
                                 oc_target=oc_target, ws_targets=[])
        nc_target.save()
        ws_target = WSTarget(usage=4000, participants=200, experiments=20,
                                 date=date, nc_target=nc_target)
        ws_target.save()

        workshop = Workshop(name="Test workshop",
                            institute=inst3,
                            status=pending_for_approval_status, 
                            artefacts=[], 
                            nc=nc,
                            ws_target=ws_target,
                            date=date,
                            participants=0,
                            experiments=0,
                            usage=0)
        workshop.save()

        rejected_workshop = self.persistent_delegate.reject_workshop(workshop)

        self.assertEqual(rejected_workshop.get("status").get("name"), reject_status.get("name"))
#+END_SRC

***  Upload Artefact
#+NAME: persistent_upload_artefact
#+BEGIN_SRC python  
    def upload_artefact(self, workshop, new_artefact):
        artefacts = workshop.get("artefacts")
        artefacts.append(new_artefact)
        return workshop
#+END_SRC
**** Tests
#+NAME: test_persistent_upload_artefact
#+BEGIN_SRC python
    def test_upload_artefact(self):
        print "test_upload_artefact"
        pending_approval = Status(name="pending for approval")
        pending_approval.save()
        inst1 = Institute(name="NIT", address="Suratkal")
        inst1.save()
        inst2 = Institute(name="IIIT", address="Hyderabad")
        inst2.save()
        inst3 = Institute(name="HCU", address="Hyderabad")
        inst3.save()
       
        oc = OC(institute=inst1, spokes=[], oc_targets=[])
        oc.save()
        nc = NC(institute=inst2, hub=oc,
                    nc_targets=[], workshops=[])
        nc.save()
        date = datetime.datetime.strptime("2016-12-23", "%Y-%m-%d").date()
        oc_target = OCTarget(usage=400, date=date, oc=oc, nc_targets=[])
        oc_target.save()
        nc_target = NCTarget(usage=400, date=date, nc=nc, 
                                 oc_target=oc_target, ws_targets=[])
        nc_target.save()
        ws_target = WSTarget(usage=4000, participants=200, experiments=20,
                                 date=date, nc_target=nc_target)
        ws_target.save()

        workshop = Workshop(name="Test workshop",
                            institute=inst3,
                            status=pending_approval, 
                            artefacts=[], 
                            nc=nc,
                            ws_target=ws_target,
                            date=date,
                            participants=0,
                            experiments=0,
                            usage=0)
        workshop.save()

        file_type = FileType(name="photo")
        file_type.save()

        new_artefact1 = Artefact(name = "Photo", path = "/main/photos/name.jpg",
                                file_type = file_type, workshop = workshop)
        new_artefact1.save()

        workshop = self.persistent_delegate.upload_artefact(workshop, new_artefact1)

        self.assertEqual(len(self.persistent_delegate.get_artefacts_of_a_workshop(workshop)), 1)
        self.assertEqual(len(self.persistent_delegate.get_artefacts()), 1)

#+END_SRC
***  Delete Artefact
#+NAME: persistent_delete_artefact
#+BEGIN_SRC python
    def delete_artefact(self, workshop, artefact):
        artefact_set = workshop.get("artefacts")
        new_set = filter(lambda art: not art.get("name") ==
                         artefact.get("name"), artefact_set)

        workshop.set(artefacts = new_set)
        workshop.set(status = Status.pending_approval)
        workshop.save()
        return workshop
#+END_SRC
**** Tests
#+NAME: test_persistent_delete_artefact
#+BEGIN_SRC python
    def test_delete_artefact(self):
        print "test_delete_artefact"
        institute = Institute(name='IIIT',address='Hyderabad')
        oc = OC(institute=Institute(name="IIITH",address="Hyderabad"), spokes=[], oc_target = None)
        nc = NC(institute=Institute(name="IIITH",address="Hyderabad"), hub=oc, nc_target = None, workshops=None)
        target_date = datetime.datetime.strptime("30-06-2016", '%d-%m-%Y').date()
        oc_target = OCTarget(usage = 400, date = target_date, nctargets = [])
        nc_target = NCTarget(usage = 200, date = target_date, oc_target = oc_target, wstargets = [])
        ws_target = WSTarget(usage = 4000, participants = 200, experiments = 20, date = target_date, nc_target = nc_target )
        name = Name(name = "New Workshop")
        status = Status(name = "pending")
        artefacts = []

        workshop = self.persistent_delegate.add_workshop(institute, name, ws_target, artefacts, status, nc)
        new_artefact = Artefact(name = "Photo", path = "/main/photos",
                                a_type = Type.photo)

        artefact_upload_workshop = self.persistent_delegate.upload_artefact(workshop, new_artefact)
        artefact_delete_workshop = self.persistent_delegate.delete_artefact(workshop, new_artefact)

        self.assertEqual(artefact_delete_workshop.get("status"), Status.pending_approval)
        self.assertEqual(len(self.persistent_delegate.get_artefacts_of_a_workshop(artefact_delete_workshop)), 0)

#+END_SRC

***  Get all workshops from the system

    This return the workshop_set maintained by the system.
#+NAME: persistent_get_workshops
#+BEGIN_SRC python
    def get_workshops(self):
        self.workshop_set = Workshop.get_all()
        return self.workshop_set

#+END_SRC
**** Tests
#+NAME: test_persistent_get_workshops
#+BEGIN_SRC python
    def test_get_all_workshops(self):
        print "test_get_all_workshops"
        institute = Institute(name='IIIT',address='Hyderabad')
        oc = OC(institute=Institute(name="IIITH",address="Hyderabad"), spokes=[], oc_target = None)
        nc = NC(institute=Institute(name="IIITH",address="Hyderabad"), hub=oc, nc_target = None, workshops=None)
        target_date = datetime.datetime.strptime("30-06-2016", '%d-%m-%Y').date()
        oc_target = OCTarget(usage = 400, date = target_date, nctargets = [])
        nc_target = NCTarget(usage = 200, date = target_date, oc_target = oc_target, wstargets = [])
        ws_target = WSTarget(usage = 4000, participants = 200, experiments = 20, date = target_date, nc_target = nc_target )
        name = Name(name = "New Workshop")
        status = Status(name = "pending")
        artefacts = []

        workshop = self.persistent_delegate.add_workshop(institute, name, ws_target, artefacts, status, nc)
        self.assertEqual(self.persistent_delegate.workshop_exists(workshop), True)
        self.assertEqual(len(self.persistent_delegate.get_workshops()), 1)
#+END_SRC


***  Get all artefacts from the system

    This return the artefact_set maintained by the system.
#+NAME: persistent_get_artefacts
#+BEGIN_SRC python
    def get_artefacts(self):
        self.artefact_set = Artefact.get_all()
        return self.artefact_set

#+END_SRC
**** Tests
#+NAME: test_persistent_get_artefacts
#+BEGIN_SRC python
    def test_get_artefacts(self):
        new_artefact = Artefact(name = "Photo", path = "/main/photos",
                                a_type = Type.photo)
        new_artefact.save()
        self.assertEqual(len(self.persistent_delegate.get_artefacts()), 1)

#+END_SRC


***  Get all artefacts of a workshop

    This return the workshop_set maintained by the system.
#+NAME: persistent_get_artefacts_of_a_workshop
#+BEGIN_SRC python
    def get_artefacts_of_a_workshop(self, workshop):
        self.artefact_set = workshop.get("artefacts")
        return self.artefact_set

#+END_SRC
**** Tests
#+NAME: test_persistent_get_artefacts_of_a_workshop
#+BEGIN_SRC python
    def test_get_artefacts_of_a_workshop(self):
        print "test_get_artefacts_of_a_workshop"
        institute = Institute(name='IIIT',address='Hyderabad')
        oc = OC(institute=Institute(name="IIITH",address="Hyderabad"), spokes=[], oc_target = None)
        nc = NC(institute=Institute(name="IIITH",address="Hyderabad"), hub=oc, nc_target = None, workshops=None)
        target_date = datetime.datetime.strptime("30-06-2016", '%d-%m-%Y').date()
        oc_target = OCTarget(usage = 400, date = target_date, nctargets = [])
        nc_target = NCTarget(usage = 200, date = target_date, oc_target = oc_target, wstargets = [])
        ws_target = WSTarget(usage = 4000, participants = 200, experiments = 20, date = target_date, nc_target = nc_target )
        name = Name(name = "New Workshop")
        status = Status(name = "pending")
        artefacts = []

        workshop = self.persistent_delegate.add_workshop(institute, name, ws_target, artefacts, status, nc)
        new_artefact = Artefact(name = "Photo", path = "/main/photos",
                                a_type = Type.photo)

        workshop = self.persistent_delegate.upload_artefact(workshop, new_artefact)

        self.assertEqual(len(self.persistent_delegate.get_artefacts_of_a_workshop(workshop)), 1)
#+BEGIN_SRC python
#+END_SRC




***  Get an object
    A generic function to find an object of type =cls= matching a given a criteria

#+NAME: persistent_get_object
#+BEGIN_SRC python
    def get_object(self, cls, **kwargs):
        ret_val = None
        try:
            ret_val = cls.apply_filters(**kwargs)[0]
        except NotFoundError as e:
            ret_val = None
        
        return ret_val

#+END_SRC
	

***  Get Name 

    This function returns a Name object from the database based on the name
    string provided.

#+NAME: persistent_get_name
#+BEGIN_SRC python
    def get_name(self, **kwargs):
        return self.get_object(Name, **kwargs)

#+END_SRC

**** Tests
#+NAME: test_persistent_get_name
#+BEGIN_SRC python
    def test_get_name(self):
         print "test_get_name"
         name = Name(name="dummy name")
         name.save()
         name_obj = self.persistent_delegate.get_name(name=name.get("name"))
         self.assertEqual(name_obj.get("name"),  name.get("name"))

#+END_SRC


***  Get Email
    This function returns an Email object from the database based on the email
    string provided.

#+NAME: persistent_get_email
#+BEGIN_SRC python
    def get_email(self, **kwargs):
        return self.get_object(Email, **kwargs)
    
#+END_SRC

**** Tests
#+NAME: test_get_email
#+BEGIN_SRC python
    def test_persistent_get_email(self):
         print "test_get_email"
         email_obj = self.persistent_delegate.get_email(email=Config.admin_email)
         self.assertEqual(email_obj.get("email"), Config.admin_email)

#+END_SRC


***  Get User
    This function returns a user if present in the database.  If the user is
    not present, =None= type is returned.
#+NAME: persistent_get_user
#+BEGIN_SRC python
    def get_user(self, **kwargs):
        return self.get_object(User, **kwargs)

#+END_SRC

**** Tests
#+NAME: test_persistent_get_user
#+BEGIN_SRC python
    def test_get_user(self):
         print "test_get_user"
         email = Email(email=Config.admin_email)
         user_obj = self.persistent_delegate.get_user(email=email)
         self.assertEqual(user_obj.get("email").get("email"), 
                              Config.admin_email)

#+END_SRC


***  Get Institute
    This function returns an institute if present in the database.  If the institute is
    not present, =None= type is returned.
#+NAME: persistent_get_institute
#+BEGIN_SRC python
    def get_institute(self, **kwargs):
        return self.get_object(Institute, **kwargs)

#+END_SRC

**** Tests
#+NAME: test_persistent_get_institute
#+BEGIN_SRC python
    def test_get_institute(self):
         print "test_get_institute"
         institute = Institute(name="IIIT", address="Hyderabad")
         institute.save()
         institute_obj = self.persistent_delegate.get_institute(name=
                                                institute.get("name"))
         self.assertEqual(institute_obj.get("name"),
                              institute.get("name"))

#+END_SRC


***  Get OC
    This function returns an =OC= if present in the database.  If =OC= is
    not present, =None= type is returned.
#+NAME: persistent_get_oc
#+BEGIN_SRC python
    def get_oc(self, **kwargs):
        return self.get_object(OC, **kwargs)

#+END_SRC

**** Tests
#+NAME: test_persistent_get_oc
#+BEGIN_SRC python
    def test_get_oc(self):
         print "test_get_oc"
         institute = Institute(name="IIIT", address="Hyderabad")
         institute.save()

         oc = OC(institute=institute, spokes=[], oc_targets=[])
         oc.save()

         oc_obj = self.persistent_delegate.get_oc(institute=
                                                oc.get("institute"))
         self.assertEqual(oc_obj.get("institute").get("name"),
                              oc.get("institute").get("name"))

#+END_SRC


***  Get NC
    This function returns an =NC= if present in the database.  If =NC= is
    not present, =None= type is returned.
#+NAME: persistent_get_nc
#+BEGIN_SRC python
    def get_nc(self, **kwargs):
        return self.get_object(NC, **kwargs)

#+END_SRC

**** Tests
#+NAME: test_persistent_get_nc
#+BEGIN_SRC python
    def test_get_nc(self):
         print "test_get_nc"
         institute = Institute(name="IIIT", address="Hyderabad")
         institute.save()

         oc = OC(institute=institute, spokes=[], oc_targets=[])
         oc.save()

         nc = NC(institute=institute, hub=oc, nc_targets=[], workshops=[])
         nc.save()

         nc_obj = self.persistent_delegate.get_nc(institute=
                                                nc.get("institute"))
         self.assertEqual(nc_obj.get("institute").get("name"),
                              nc.get("institute").get("name"))

#+END_SRC


***  Get Role
    This function returns either admin or user role from the roles in database
#+NAME: persistent_get_role
#+BEGIN_SRC python
    def get_role(self, **kwargs):
        return self.get_object(Role, **kwargs)

#+END_SRC

**** Tests
#+NAME: test_persistent_get_role
#+BEGIN_SRC python
    def test_get_role(self):
         print "test_get_role"
         role_obj = self.persistent_delegate.get_role(name=Config.admin_role)
         self.assertEqual(role_obj.get("name"), Config.admin_role)

#+END_SRC



***  Get Status
    This function returns the =Status= if present in the database.  If =Status= is
    not present, =None= type is returned.
#+NAME: persistent_get_status
#+BEGIN_SRC python
    def get_status(self, **kwargs):
        return self.get_object(Status, **kwargs)

#+END_SRC

**** Tests
#+NAME: test_persistent_get_status
#+BEGIN_SRC python
    def test_get_status(self):
         print "test_get_status"
         
         pending = Status(name="pending")
         pending.save()
         status_obj = self.persistent_delegate.get_status(name=\
                                                        pending.get("name"))
         self.assertEqual(status_obj.get("name"), pending.get("name"))                                           

#+END_SRC


***  Get Workshop
    This function returns the workshop if present in the database.  If the workshop is
    not present, =None= type is returned.
#+NAME: persistent_get_workshop
#+BEGIN_SRC python
    def get_workshop(self, **kwargs):
        return self.get_object(Workshop, **kwargs)

#+END_SRC

**** Tests
#+NAME: test_persistent_get_workshop
#+BEGIN_SRC python
    def test_get_workshop(self):
         print "test_get_workshop"

         status = Status(name="pending")
         status.save()
         inst1 = Institute(name="NIT", address="Suratkal")
         inst1.save()
         inst2 = Institute(name="IIIT", address="Hyderabad")
         inst2.save()
         inst3 = Institute(name="HCU", address="Hyderabad")
         inst3.save()
        
         oc = OC(institute=inst1, spokes=[], oc_targets=[])
         oc.save()
        
         nc = NC(institute=inst2, hub=oc,
                 nc_targets=[], workshops=[])
         nc.save()

         date = datetime.datetime.strptime("2016-12-23", "%Y-%m-%d").date()

         oc_target = OCTarget(usage=400, date=date, oc=oc, nc_targets=[])
         oc_target.save()
         nc_target = NCTarget(usage=400, date=date, nc=nc, 
                                oc_target=oc_target, ws_targets=[])
         nc_target.save()
         ws_target = WSTarget(usage=4000, participants=200, experiments=20,
                                  date=date, nc_target=nc_target)
         ws_target.save()

         workshop = Workshop(name="Test workshop",
                                institute=inst3,
                                status=status, 
                                artefacts=[], 
                                nc=nc,
                                ws_target=ws_target,
                                date=date,
                                participants=0,
                                experiments=0,
                                usage=0)
         workshop.save()

         workshop_obj = self.persistent_delegate.get_workshop(name="Test"
                                                              " workshop", 
                                                              institute=inst3,
                                                              nc=nc,
                                                              date=date)
         self.assertEqual(workshop_obj.get("name"), workshop.get("name"))

#+END_SRC


***  Get user by Email
    This function returns the user by email from the database
#+NAME: get_user_by_email
#+BEGIN_SRC python
    def get_user_by_email(self, email):
        return self.get_user(email=email)

#+END_SRC

**** Tests
#+NAME: test_get_user_by_email
#+BEGIN_SRC python
    def test_get_user_by_email(self):
        print "test_get_user_by_email"
        email = Email(email=Config.admin_email)
        user = self.persistent_delegate.get_user_by_email(email)
        self.assertEqual(user.get("email"), email)

        email = Email(email="tt@kk.com")
        email.save()
        user = self.persistent_delegate.get_user_by_email(email)
        self.assertEqual(user, None)

#+END_SRC


* Infra                                                         :boilerplate:

** sources
*** Imports 

#+name: imports_for_persistent_delegates
#+BEGIN_SRC python
# -*- coding: utf-8 -*-
from runtime.persistence.entities import *
from runtime.config.config import Config
from runtime.exceptions.custom_exceptions import *
#+end_src

** Tests
*** Imports 

#+name: imports_for_tests_persistence
#+BEGIN_SRC python
# -*- coding: utf-8 -*-
import unittest
from flask_testing import TestCase
from runtime.rest.app import create_app
from runtime.system.persistent_delegates import *


config = {
         'SQLALCHEMY_DATABASE_URI': ''
         }
#+end_src


*** Running tests
#+NAME: run_test_cases
#+BEGIN_SRC python
if __name__ == '__main__':
    unittest.main()

#+END_SRC


* Tangling                                                      :boilerplate:
  
** sources

#+BEGIN_SRC python :tangle persistent_delegates.py :eval no :noweb yes
<<imports_for_persistent_delegates>>
<<class_persistence_delegate>>
<<persistent_get_object>>
<<persistent_get_role_set>>
<<persistent_get_user_set>>
<<persistent_user_exists>>
<<persistent_email_exists>>
<<persistent_name_exists>>
<<persistent_add_user>>
<<persistent_get_user>>
<<persistent_get_email>>
<<persistent_get_name>>
<<persistent_get_institute>>
<<persistent_get_oc>>
<<persistent_get_nc>>
<<persistent_get_status>>
<<persistent_get_workshop>>
<<persistent_update_user>>
<<persistent_delete_user>>
<<persistent_add_role_to_user>>
<<persistent_get_users>>
<<persistent_get_role>>
<<persistent_get_active_users>>
<<persistent_add_oc>>
<<persistent_add_nc>>
<<persistent_get_ocs>>
<<persistent_get_ncs>>
<<persistent_oc_exists>>
<<persistent_nc_exists>>
<<persistent_role_exists>>
<<persistent_add_role>>
<<persistent_add_occ_role>>
<<persistent_add_ncc_role>>
<<persistent_get_roles>>
<<persistent_add_institute>>
<<persistent_update_institute>>
<<persistent_get_institutes>>
<<persistent_institute_exists>>
<<persistent_add_workshop>>
<<persistent_cancel_workshop>>
<<persistent_reschedule_workshop>>
<<persistent_conduct_workshop>>
<<persistent_approve_workshop>>
<<persistent_reject_workshop>>
<<persistent_workshop_exists>>
<<persistent_upload_artefact>>
<<persistent_delete_artefact>>
<<persistent_get_workshops>>
<<persistent_get_artefacts>>
<<persistent_get_artefacts_of_a_workshop>>
<<persistent_get_active_users>>
#+end_src

** tests
#+BEGIN_SRC python :tangle test_persistent_delegates.py :eval no :noweb yes
<<imports_for_tests_persistence>>
<<test_class_persistent_delegate>>
<<test_persistent_user_exists>>
<<test_persistent_email_exists>>
<<test_persistent_name_exists>>
<<test_persistent_get_name>>
<<test_persistent_add_user>>
#<<test_persistent_get_user>>
#<<test_persistent_get_role>>
#<<test_persistent_get_email>>
<<test_persistent_get_institute>>
<<test_persistent_get_oc>>
<<test_persistent_get_nc>>
<<test_persistent_get_status>>
<<test_persistent_get_workshop>>
#<<test_persistent_update_user>>
#<<test_persistent_delete_user>>
<<test_persistent_add_role_to_user>>
#<<test_persistent_get_users>>
#<<test_persistent_get_active_users>>
<<test_persistent_add_oc>>
<<test_persistent_oc_exists>>
<<test_persistent_add_nc>>
<<test_persistent_nc_exists>>
#<<test_persistent_get_ocs>>
#<<test_persistent_get_ncs>>
#<<test_persistent_role_exists>>
<<test_persistent_add_role>>
#<<test_persistent_get_roles>>
<<test_persistent_institute_exists>>
<<test_persistent_add_institute>>
#<<test_persistent_update_institute>>
#<<test_persistent_get_institutes>>
<<test_persistent_add_workshop>>
<<test_persistent_workshop_exists>>
<<test_persistent_cancel_workshop>>
<<test_persistent_reschedule_workshop>>
<<test_persistent_conduct_workshop>>
<<test_persistent_upload_artefact>>
<<test_persistent_approve_workshop>>
<<test_persistent_reject_workshop>>
#<<test_persistent_delete_artefact>>
#<<test_persistent_get_workshops>>
#<<test_persistent_get_artefacts>>
#<<test_persistent_get_artefacts_of_a_workshop>>
#<<test_persistent_get_active_users>>
<<run_test_cases>>

#+end_src

